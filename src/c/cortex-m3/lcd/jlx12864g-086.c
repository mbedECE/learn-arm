#include "jlx12864g-086.h"

#include "delay.h"

uint32_t SPI = 0;
uint32_t PORT = 0;
uint32_t MOSI = 0;
uint32_t SCK = 0;
uint32_t NSS = 0;
uint32_t RS = 0;
uint32_t RST = 0;
uint32_t LEDA = 0;
uint32_t CLK = 0;

static const uint8_t dummy[] = {};
static const uint8_t exclamation[] = {0x00, 0x00, 0x00, 0x4F, 0x00, 0x00, 0x00, 0x00}; 
static const uint8_t percentage[] = {0x00, 0x23, 0x13, 0x08, 0x64, 0x62, 0x00, 0x00}; 
static const uint8_t question[] = {0x00, 0x02, 0x01, 0x51, 0x09, 0x06, 0x00, 0x00}; 
static const uint8_t colon[] = {0x00, 0x00, 0x36, 0x36, 0x00, 0x00, 0x00, 0x00}; 
static const uint8_t equal[] = {0x00, 0x14, 0x14, 0x14, 0x14, 0x14, 0x00, 0x00}; 
static const uint8_t minus[] = {0x00, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00}; 
static const uint8_t plus[] = {0x00, 0x08, 0x08, 0x3E, 0x08, 0x08, 0x00, 0x00}; 

static const uint8_t zero[] = {0x00, 0x3E, 0x41, 0x41, 0x41, 0x3e, 0x00, 0x00};
static const uint8_t one[] = {0x00, 0x44, 0x42, 0x7F, 0x40, 0x40, 0x00, 0x00}; 
static const uint8_t two[] = {0x00, 0x42, 0x61, 0x51, 0x49, 0x46, 0x00, 0x00};
static const uint8_t three[] = {0x00, 0x21, 0x41, 0x45, 0x4B, 0x31, 0x00, 0x00};
static const uint8_t four[] = {0x00, 0x18, 0x14, 0x12, 0x7F, 0x10, 0x00, 0x00};
static const uint8_t five[] = {0x00, 0x27, 0x45, 0x45, 0x45, 0x39, 0x00, 0x00};
static const uint8_t six[] = {0x00, 0x2C, 0x4A, 0x49, 0x49, 0x30, 0x00, 0x00};
static const uint8_t seven[] = {0x00, 0x03, 0x01, 0x71, 0x09, 0x07, 0x00, 0x00};
static const uint8_t eight[] = {0x00, 0x36, 0x49, 0x49, 0x49, 0x36, 0x00, 0x00};
static const uint8_t nine[] = {0x00, 0x06, 0x49, 0x49, 0x29, 0x1E, 0x00, 0x00};

static const uint8_t A[] = {0x00, 0x3C, 0x12, 0x11, 0x12, 0x3C, 0x00, 0x00};
static const uint8_t B[] = {0x00, 0x7F, 0x49, 0x49, 0x49, 0x36, 0x00, 0x00};
static const uint8_t C[] = {0x00, 0x3E, 0x41, 0x41, 0x41, 0x22, 0x00, 0x00};
static const uint8_t D[] = {0x00, 0x7F, 0x41, 0x41, 0x22, 0x1C, 0x00, 0x00};
static const uint8_t E[] = {0x00, 0x7F, 0x49, 0x49, 0x49, 0x41, 0x00, 0x00};
static const uint8_t F[] = {0x00, 0x7F, 0x09, 0x09, 0x09, 0x01, 0x00, 0x00};
static const uint8_t G[] = {0x00, 0x3F, 0x41, 0x49, 0x49, 0x72, 0x00, 0x00};
static const uint8_t H[] = {0x00, 0x7F, 0x08, 0x08, 0x08, 0x7F, 0x00, 0x00};
static const uint8_t I[] = {0x00, 0x00, 0x41, 0x7F, 0x41, 0x00, 0x00, 0x00};
static const uint8_t J[] = {0x00, 0x20, 0x40, 0x41, 0x3F, 0x01, 0x00, 0x00};
static const uint8_t K[] = {0x00, 0x7F, 0x08, 0x14, 0x22, 0x41, 0x00, 0x00};
static const uint8_t L[] = {0x00, 0x7F, 0x40, 0x40, 0x40, 0x40, 0x00, 0x00};
static const uint8_t M[] = {0x00, 0x7F, 0x02, 0x0C, 0x02, 0x7F, 0x00, 0x00};
static const uint8_t N[] = {0x00, 0x7F, 0x04, 0x08, 0x02, 0x7F, 0x00, 0x00};
static const uint8_t O[] = {0x00, 0x3F, 0x41, 0x41, 0x41, 0x3F, 0x00, 0x00};
static const uint8_t P[] = {0x00, 0x7F, 0x09, 0x09, 0x09, 0x06, 0x00, 0x00};
static const uint8_t Q[] = {0x00, 0x3F, 0x41, 0x51, 0x21, 0x5E, 0x00, 0x00};
static const uint8_t R[] = {0x00, 0x7F, 0x09, 0x19, 0x29, 0x46, 0x00, 0x00};
static const uint8_t S[] = {0x00, 0x26, 0x49, 0x49, 0x49, 0x32, 0x00, 0x00};
static const uint8_t T[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00}; 
static const uint8_t U[] = {0x00, 0x3F, 0x40, 0x40, 0x40, 0x3F, 0x00, 0x00};
static const uint8_t V[] = {0x00, 0x1F, 0x20, 0x40, 0x20, 0x1F, 0x00, 0x00};
static const uint8_t W[] = {0x00, 0x3F, 0x40, 0x38, 0x40, 0x3F, 0x00, 0x00};
static const uint8_t X[] = {0x00, 0x63, 0x14, 0x08, 0x14, 0x63, 0x00, 0x00};
static const uint8_t Y[] = {0x00, 0x07, 0x08, 0x70, 0x08, 0x07, 0x00, 0x00};
static const uint8_t Z[] = {0x00, 0x61, 0x51, 0x49, 0x45, 0x43, 0x01, 0x00};

static const uint8_t a[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00};
static const uint8_t b[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00};
static const uint8_t c[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00};
static const uint8_t d[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00};
static const uint8_t e[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00};
static const uint8_t f[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00};
static const uint8_t g[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00};
static const uint8_t h[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00};
static const uint8_t i[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00};
static const uint8_t j[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00};
static const uint8_t k[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00};
static const uint8_t l[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00};
static const uint8_t m[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00};
static const uint8_t n[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00};
static const uint8_t o[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00};
static const uint8_t p[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00};
static const uint8_t q[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00};
static const uint8_t r[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00};
static const uint8_t s[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00};
static const uint8_t t[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00};
static const uint8_t u[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00};
static const uint8_t v[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00};
static const uint8_t w[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00};
static const uint8_t x[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00};
static const uint8_t y[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00};
static const uint8_t z[] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x01, 0x00};

static const uint8_t *ascii_table [] = {
	dummy, dummy, dummy, dummy, dummy, dummy, dummy, dummy, dummy, dummy, dummy, dummy, dummy, dummy, dummy, dummy, 
	dummy, dummy, dummy, dummy, dummy, dummy, dummy, dummy, dummy, dummy, dummy, dummy, dummy, dummy, dummy, dummy, 
	dummy, exclamation, dummy, dummy, dummy, percentage, dummy, dummy, dummy, dummy, dummy, plus, dummy, minus, dummy, dummy,
	zero, one, two, three, four, five, six, seven, eight, nine, colon, dummy, dummy, equal, dummy, question,
	dummy, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, 
	P, Q, R, S, T, U, V, W, X, Y, Z, dummy, dummy, dummy, dummy, dummy, 
	dummy, a, b, c, d, e, f, g, h, i, j, k, l, m, n, o, 
	p, q, r, s, t, u, v, w, x, y, z, dummy, dummy, dummy, dummy, dummy
};

void print(uint8_t ascii, uint8_t row, uint8_t col)
{
	for(uint8_t i=0; i<8; i++)
	{
		setCursor(col+i, row);
		sendData(ascii_table[ascii][i]);
	}
}

void lcdInit(uint32_t module, uint32_t port, uint32_t mosi, uint32_t sck, uint32_t nss, uint32_t rs, uint32_t rst, uint32_t leda, uint32_t sysclk)
{
	SPI = module;
	PORT = port;
	MOSI = mosi;
	SCK = sck;
	NSS = nss;
	RS = rs;
	RST = rst;
	LEDA = leda;
	CLK = sysclk;

	delays_init(CLK);
	
	//Enable the SPI peripheral clock
	enableSpiClk();
	
	if(PORT == PORTA)
		enablePeripheralClock(RCC_APB2ENR_IOPAEN);
	
	if(PORT == PORTB)
		enablePeripheralClock(RCC_APB2ENR_IOPBEN);
		
	configurePortPin(PORT, MOSI, CNF_MODE_OUTPUT_AF_PP, MODE_OUTPUT_50MHz);	//MOSI
	configurePortPin(PORT, SCK, CNF_MODE_OUTPUT_AF_PP, MODE_OUTPUT_50MHz);	//SCK
	configurePortPin(PORT, NSS, CNF_MODE_OUTPUT_AF_PP, MODE_OUTPUT_50MHz);	//NSS
	
	configurePortPin(PORT, RS, CNF_MODE_OUTPUT_GP_PP, MODE_OUTPUT_50MHz);	//RS
	configurePortPin(PORT, RST, CNF_MODE_OUTPUT_GP_PP, MODE_OUTPUT_50MHz);	//RESET
	configurePortPin(PORT, LEDA, CNF_MODE_OUTPUT_GP_PP, MODE_OUTPUT_2MHz);	//LEDA
	
	//Configure the MCU as SPI master
	setBIDIMODE(SPI, false);	//2-line unidirectional data mode selected
	setRXONLY(SPI, false);		//Full duplex (Transmit and receive)
	setBR(SPI, 0x7);		//set the baud rate = PCLK/256
	setCPOL(SPI,false);		//set the polarity = 0
	setCPHA(SPI, false);		//set the phase = 0
	setDFF(SPI, false);		//8-bit format
	setLSBFIRST(SPI, false);	//MSB sent first
	setSSM(SPI, false);		//Disable software slave management
	setSSOE(SPI, true);		//SS output is enabled
	setMSTR(SPI, true);		//master mode
	
	pinState(PORT, LEDA, HIGH);	//backlight on
		
	//start the lcd initialization procedure
	pinState(PORT, RST, LOW);
	delay_ms(2);
	pinState(PORT, RST, HIGH);
	delay_ms(10);

 	sendCMD(0xE2); // Soft Reset
 	sendCMD(0x40); // set LCD start line to 0
	sendCMD(0x2C); // Boost 1
	sendCMD(0x2E); // Boost 2
	sendCMD(0x2F); // Boost 3
	sendCMD(0xC8); // Line scan sequence : from top to bottom
	sendCMD(0xA0); // Column scanning order : from left to right
	
	delay_ms(150);
	
	sendCMD(0xA2); // 1/9 bias ratio (1/7 bias ratio [0xA3])
	
	sendCMD(0x23); // Coarse Contrast, setting range is from 20 to 27
	sendCMD(0x81); // Trim Contrast
	sendCMD(0x20); // Trim Contrast value range can be set from 0 to 63
	
	sendCMD(0xAF); //enable display	
	delay_ms(100);
	sendCMD(0xA5); //display all points
	delay_ms(200);
	sendCMD(0xA4); //normal display
	
	setDisplayState(DISPLY_STATE_ON); // Open the display	
	clearScreen();		
}


void clearScreen(void)
{
	for(uint8_t i=0; i<8; i++) 
	{		
		for(uint8_t j=0; j<128; j++) 
		{	
			setCursor(j, i);
			sendData(0x00);
		}
	}	
}


void sendCMD(uint16_t cmd)
{
	enableSPI(SPI);
	pinState(PORT, RS, LOW);	

	while(!getTXE(SPI));		//wait for TXE bit to go high i.e TX buffer empty
	spiTransfer(SPI, cmd);
	disableSPI(SPI);
}

void sendData(uint16_t data)
{
	enableSPI(SPI);
	pinState(PORT, RS, HIGH);	

	while(!getTXE(SPI));		//wait for TXE bit to go high i.e TX buffer empty
	spiTransfer(SPI, data);
	disableSPI(SPI);
}

void setDisplayState(uint16_t state)
{
	sendCMD(state);
}

void setCursor(uint32_t x, uint32_t y)
{ 
	// y with Page 0 - 8 
	// x = 0 - 127
	sendCMD(0xB0+y);
	sendCMD(0x10+(x/16));
	sendCMD(0x00+(x%16));
}




